\documentclass{article}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{bm}
\usepackage{algorithm}
\usepackage{algorithmic}
\usepackage{enumitem}

\newcommand{\vect}[1]{\bm{#1}}
\newcommand{\mat}[1]{\bm{#1}}
\newcommand{\quat}[1]{\mathbf{#1}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\E}{\mathbb{E}}
\newcommand{\T}{\mathsf{T}}

\begin{document}

\title{Complete Mathematical Formulation of the Multiplicative Extended Kalman Filter with Linear Navigation States}
\author{}
\maketitle

\section{State Representation and Coordinate System}

The filter estimates an extended state vector in NED (North-East-Down) coordinates:

\begin{equation}
\vect{x} = 
\begin{bmatrix}
\vect{\theta}_{\text{err}} \\
\vect{b}_g \\
\vect{v} \\
\vect{p} \\
\vect{S} \\
\vect{a}_w \\
\vect{b}_a
\end{bmatrix}
\in \R^{N_X}, \quad 
N_X = 3 + 3\delta_{bg} + 12 + 3\delta_{ba}
\end{equation}

where:
\begin{align*}
\vect{\theta}_{\text{err}} &\in \R^3 \quad \text{attitude error vector (right-multiplicative convention)} \\
\vect{b}_g &\in \R^3 \quad \text{gyroscope bias (rad/s)} \\
\vect{v} &\in \R^3 \quad \text{velocity in world frame (m/s)} \\
\vect{p} &\in \R^3 \quad \text{position in world frame (m)} \\
\vect{S} &\in \R^3 \quad \text{integral of displacement } \vect{S} = \int \vect{p}  dt \text{ (m·s)} \\
\vect{a}_w &\in \R^3 \quad \text{world acceleration (m/s²)} \\
\vect{b}_a &\in \R^3 \quad \text{accelerometer bias (m/s²)}
\end{align*}

The attitude uses multiplicative error formulation:
\begin{equation}
\quat{q} = \quat{q}_{\text{ref}} \otimes \delta\quat{q}(\vect{\theta}_{\text{err}})
\end{equation}

Gravity vector in NED coordinates:
\begin{equation}
\vect{g} = [0, 0, +g]^\T, \quad g = 9.80665 \text{ m/s²}
\end{equation}

\section{Quaternion Operations and Attitude Representation}

\subsection{Small Rotation Quaternion from Rotation Vector}

\begin{equation}
\delta\quat{q}(\vect{\theta}) = 
\begin{cases}
\begin{bmatrix}
w \\
\vect{v}
\end{bmatrix}
=
\begin{bmatrix}
1 - \frac{\|\vect{\theta}\|^2}{8} + \frac{\|\vect{\theta}\|^4}{384} \\
\left(\frac{1}{2} - \frac{\|\vect{\theta}\|^2}{48} + \frac{\|\vect{\theta}\|^4}{3840}\right) \vect{\theta}
\end{bmatrix}
& \|\vect{\theta}\| < 10^{-2} \\
\begin{bmatrix}
\cos(\|\vect{\theta}\|/2) \\
\frac{\sin(\|\vect{\theta}\|/2)}{\|\vect{\theta}\|} \vect{\theta}
\end{bmatrix}
& \text{otherwise}
\end{cases}
\end{equation}

\subsection{Quaternion Correction and Error State Reset}

After each measurement update:
\begin{align}
\quat{q}_{\text{ref}} &\leftarrow \quat{q}_{\text{ref}} \otimes \delta\quat{q}(\vect{\theta}_{\text{err}}) \\
\vect{\theta}_{\text{err}} &\leftarrow \vect{0}
\end{align}

\subsection{Skew-Symmetric Matrix}

\begin{equation}
[\vect{v}]_\times = 
\begin{bmatrix}
0 & -v_z & v_y \\
v_z & 0 & -v_x \\
-v_y & v_x & 0
\end{bmatrix}
\end{equation}

\section{Measurement Models}

\subsection{Accelerometer Measurement Model}

\begin{equation}
\vect{f}_b = \vect{R}_{wb}(\vect{a}_w - \vect{g}) + \vect{b}_a(T) + \vect{v}_a, \quad \vect{v}_a \sim \mathcal{N}(\vect{0}, \vect{R}_{\text{acc}})
\end{equation}

Temperature-compensated accelerometer bias:
\begin{equation}
\vect{b}_a(T) = \vect{b}_{a0} + \vect{k}_a(T - T_{\text{ref}}), \quad T_{\text{ref}} = 35^\circ\text{C}
\end{equation}

Measurement Jacobians:
\begin{align}
\vect{J}_{\theta} &= \frac{\partial \vect{f}_b}{\partial \vect{\theta}} = -[\vect{f}_b]_\times \\
\vect{J}_{a_w} &= \frac{\partial \vect{f}_b}{\partial \vect{a}_w} = \vect{R}_{wb} \\
\vect{J}_{b_a} &= \frac{\partial \vect{f}_b}{\partial \vect{b}_a} = \vect{I}
\end{align}

\subsection{Magnetometer Measurement Model}

\begin{equation}
\vect{m}_b = \vect{R}_{wb} \vect{B}_{\text{ref}} + \vect{v}_m, \quad \vect{v}_m \sim \mathcal{N}(\vect{0}, \vect{R}_{\text{mag}})
\end{equation}

Measurement Jacobian:
\begin{equation}
\vect{J}_{\theta} = \frac{\partial \vect{m}_b}{\partial \vect{\theta}} = -[\vect{m}_b]_\times
\end{equation}

\subsection{Integral State Pseudo-Measurement}

\begin{equation}
\vect{z}_S = \vect{S} + \vect{v}_S, \quad \vect{v}_S \sim \mathcal{N}(\vect{0}, \vect{R}_S)
\end{equation}
Applied every $N$ time updates with innovation $\vect{r}_S = \vect{0} - \vect{S}$.

\section{Continuous-Time Process Model}

\subsection{Attitude Dynamics}

\begin{align}
\dot{\quat{q}} &= \frac{1}{2} \quat{q} \otimes [0, \vect{\omega}]^\T \\
\vect{\omega} &= \vect{\omega}_{\text{meas}} - \vect{b}_g \\
\dot{\vect{\theta}}_{\text{err}} &= -\vect{\omega} \times \vect{\theta}_{\text{err}} - \delta\vect{b}_g + \vect{w}_g \\
\dot{\vect{b}}_g &= \vect{w}_{bg}, \quad \vect{w}_{bg} \sim \mathcal{N}(\vect{0}, \vect{Q}_{bg})
\end{align}

\subsection{Linear Navigation Dynamics}

\begin{align}
\dot{\vect{v}} &= \vect{a}_w \\
\dot{\vect{p}} &= \vect{v} \\
\dot{\vect{S}} &= \vect{p} \\
\dot{\vect{a}}_w &= -\frac{1}{\tau}\vect{a}_w + \vect{w}_a, \quad \vect{w}_a \sim \mathcal{N}(\vect{0}, \vect{\Sigma}_{\text{aw\_stat}}) \\
\dot{\vect{b}}_a &= \vect{w}_{ba}, \quad \vect{w}_{ba} \sim \mathcal{N}(\vect{0}, \vect{Q}_{ba})
\end{align}

\section{Discretization of Process Model}

\subsection{Quaternion Discretization}

\begin{equation}
\quat{q}_{k+1} = \quat{q}_k \otimes \quat{q}((\vect{\omega}_{\text{meas}} - \vect{b}_g)\Delta t)
\end{equation}

\subsection{Attitude Error State Transition Matrix}

\begin{equation}
\vect{F}_{AA} = 
\begin{bmatrix}
\vect{F}_{\theta\theta} & \vect{F}_{\theta b_g} \\
\vect{0} & \vect{I}
\end{bmatrix}
\end{equation}

For $\theta = \|\vect{\omega}\|\Delta t$:
\begin{equation}
\vect{F}_{\theta\theta} = 
\begin{cases}
\vect{I} - [\vect{\omega}]_\times \Delta t + \frac{1}{2}[\vect{\omega}]_\times^2 \Delta t^2 & \theta < 10^{-5} \\
\vect{I} - \sin\theta \vect{W} + (1-\cos\theta)\vect{W}^2 & \text{otherwise}
\end{cases}
\end{equation}
where $\vect{W} = \frac{[\vect{\omega}]_\times}{\|\vect{\omega}\|}$, and $\vect{F}_{\theta b_g} = -\vect{I}\Delta t$.

\subsection{Linear States Discretization}

For each axis, the discrete transition matrix:
\begin{equation}
\vect{F}_{\text{axis}} = 
\begin{bmatrix}
1 & 0 & 0 & \phi_{va} \\
\Delta t & 1 & 0 & \phi_{pa} \\
\frac{1}{2}\Delta t^2 & \Delta t & 1 & \phi_{Sa} \\
0 & 0 & 0 & \alpha
\end{bmatrix}
\end{equation}

where for $x = \Delta t/\tau$:
\begin{align}
\alpha &= e^{-x} \\
\phi_{va} &= -\tau(1 - \alpha) \\
\phi_{pa} &= \tau^2(x + (1 - \alpha)) \\
\phi_{Sa} &= \tau^3\left(\frac{1}{2}x^2 - x - (1 - \alpha)\right)
\end{align}

For small $x < 10^{-2}$, Maclaurin expansions:
\begin{align}
\phi_{pa} &\approx \tau^2\left(\frac{1}{2}x^2 - \frac{1}{6}x^3 + \frac{1}{24}x^4\right) \\
\phi_{Sa} &\approx \tau^3\left(\frac{1}{6}x^3 - \frac{1}{24}x^4 + \frac{1}{120}x^5\right)
\end{align}

\section{Process Noise Covariance Discretization}

\subsection{Ornstein-Uhlenbeck Process Primitives}

\begin{align}
x &= \frac{\Delta t}{\max(\tau, 10^{-8})} \\
\alpha &= e^{-x} \\
\text{em1} &= e^{-x} - 1 \\
\alpha_2 &= e^{-2x} \\
\text{em1}_2 &= e^{-2x} - 1
\end{align}

\subsection{Discrete OU Coefficients}

Helper coefficients for small $x < 10^{-2}$:
\begin{align}
A_1 &\approx \tau^2\left(\frac{1}{2}x^2 - \frac{1}{3}x^3 + \frac{1}{8}x^4\right) \\
A_2 &\approx \tau^3\left(\frac{1}{3}x^3 - \frac{1}{4}x^4 + \frac{1}{10}x^5\right)
\end{align}

For general $x$:
\begin{align}
A_1 &= \tau^2(-em1 - x\alpha) \\
A_2 &= \tau^3(-2em1 + \alpha(x(x+2)))
\end{align}

\subsection{Process Noise per Axis}

For each axis with stationary variance $\sigma_a^2$:
\begin{equation}
\vect{Q}_d^{(i)} = \frac{2\sigma_a^2}{\tau} \vect{K}
\end{equation}

For small $x = \Delta t/\tau < 3\times10^{-3}$:
\begin{align}
K_{vv} &\approx \frac{\Delta t^3}{3} - \frac{\Delta t^4}{4\tau} \\
K_{pp} &\approx \frac{\Delta t^5}{20} - \frac{\Delta t^6}{30\tau} \\
K_{SS} &\approx \frac{\Delta t^7}{840} - \frac{\Delta t^8}{960\tau} \\
K_{aa} &\approx \Delta t - \frac{\Delta t^2}{\tau} + \frac{2\Delta t^3}{3\tau^2} - \frac{\Delta t^4}{3\tau^3} \\
K_{va} &\approx \frac{\Delta t^2}{2} - \frac{\Delta t^3}{3\tau} + \frac{\Delta t^4}{8\tau^2} \\
K_{pa} &\approx \frac{\Delta t^3}{6} - \frac{\Delta t^4}{8\tau} \\
K_{Sa} &\approx \frac{\Delta t^4}{24} - \frac{\Delta t^5}{30\tau} \\
K_{pv} &\approx \frac{\Delta t^4}{12} - \frac{\Delta t^5}{15\tau} \\
K_{Sv} &\approx \frac{\Delta t^5}{60} - \frac{\Delta t^6}{72\tau} \\
K_{Sp} &\approx \frac{\Delta t^6}{360} - \frac{\Delta t^7}{420\tau}
\end{align}

For general $x$:
\begin{align}
K_{vv} &= \tau^2\left[\Delta t - 2A_0 + B_0\right] \\
K_{pp} &= \tau^2\left[\frac{1}{3}\Delta t^3 - 2\tau^2(x + em1) + B_0\Delta t^2\right] \\
K_{SS} &= \tau^2\left[\frac{1}{20}\Delta t^5 - 2\tau^3\left(\frac{1}{2}x^2 - x - em1\right) + B_0\frac{1}{4}\Delta t^4\right] \\
K_{aa} &= B_0 \\
K_{va} &= \tau\left[A_0 - B_0\right] \\
K_{pa} &= \tau\left[\tau^2(x + em1) - A_0\Delta t + B_0\Delta t\right] \\
K_{Sa} &= \tau\left[\frac{1}{2}\tau^3\left(\frac{1}{2}x^2 - x - em1\right) - \tau^2(x + em1)\Delta t + B_0\frac{1}{2}\Delta t^2\right] \\
K_{pv} &= \tau^2\left[\frac{1}{2}\Delta t^2 - \tau^2(x + em1) + B_0\Delta t\right] \\
K_{Sv} &= \tau^2\left[\frac{1}{6}\Delta t^3 - \tau^3\left(\frac{1}{2}x^2 - x - em1\right) + B_0\frac{1}{2}\Delta t^2\right] \\
K_{Sp} &= \tau^2\left[\frac{1}{12}\Delta t^4 - \tau^3\left(\frac{1}{2}x^2 - x - em1\right)\Delta t + B_0\frac{1}{3}\Delta t^3\right]
\end{align}
where $A_0 = -\tau(1 - \alpha)$ and $B_0 = -\frac{\tau}{2}(1 - \alpha_2)$.

\subsection{Cross-Axis Correlation}

For correlated world acceleration with correlation coefficient $\rho$:
\begin{equation}
\vect{\Sigma}_{\text{aw\_stat}} = 
\begin{bmatrix}
\sigma_x^2 & 0 & \rho\sigma_x\sigma_z \\
0 & \sigma_y^2 & \rho\sigma_y\sigma_z \\
\rho\sigma_x\sigma_z & \rho\sigma_y\sigma_z & \sigma_z^2
\end{bmatrix}
\end{equation}

Full discrete process noise construction:
\begin{align}
\vect{\Sigma}_{\text{aw\_stat}} &= \vect{L}\vect{L}^\T \quad \text{(Cholesky decomposition)} \\
\vect{Q}_{\text{kron}} &= \begin{bmatrix}
\Sigma_{11}\vect{Q}_{\text{axis}} & \Sigma_{12}\vect{Q}_{\text{axis}} & \Sigma_{13}\vect{Q}_{\text{axis}} \\
\Sigma_{21}\vect{Q}_{\text{axis}} & \Sigma_{22}\vect{Q}_{\text{axis}} & \Sigma_{23}\vect{Q}_{\text{axis}} \\
\Sigma_{31}\vect{Q}_{\text{axis}} & \Sigma_{32}\vect{Q}_{\text{axis}} & \Sigma_{33}\vect{Q}_{\text{axis}}
\end{bmatrix} \\
\vect{Q}_{LL} &= \vect{P} \vect{Q}_{\text{kron}} \vect{P}^\T \quad \text{(permutation to state ordering)}
\end{align}

\section{Kalman Filter Equations}

\subsection{Time Update (Prediction)}

State propagation:
\begin{align}
\vect{x}_{k+1|k} &= \vect{F} \vect{x}_{k|k} \\
\vect{P}_{k+1|k} &= \vect{F} \vect{P}_{k|k} \vect{F}^\T + \vect{Q}_d
\end{align}

Block covariance propagation:
\begin{align}
\vect{P}_{AA} &= \vect{F}_{AA} \vect{P}_{AA} \vect{F}_{AA}^\T + \vect{Q}_{AA} \\
\vect{P}_{LL} &= \vect{F}_{LL} \vect{P}_{LL} \vect{F}_{LL}^\T + \vect{Q}_{LL} \\
\vect{P}_{AL} &= \vect{F}_{AA} \vect{P}_{AL} \vect{F}_{LL}^\T
\end{align}

\subsection{Measurement Update (Correction)}

For measurement $\vect{z}$ with model $\vect{h}(\vect{x})$ and Jacobian $\vect{C}$:

Innovation computation:
\begin{align}
\vect{r} &= \vect{z} - \vect{h}(\vect{x}) \\
\vect{S} &= \vect{C} \vect{P} \vect{C}^\T + \vect{R}
\end{align}

Kalman gain:
\begin{equation}
\vect{K} = \vect{P} \vect{C}^\T \vect{S}^{-1}
\end{equation}

State update:
\begin{equation}
\vect{x}_{k+1|k+1} = \vect{x}_{k+1|k} + \vect{K} \vect{r}
\end{equation}

Joseph form covariance update:
\begin{align}
\vect{P}^+ &= (\vect{I} - \vect{K} \vect{C}) \vect{P}^- (\vect{I} - \vect{K} \vect{C})^\T + \vect{K} \vect{R} \vect{K}^\T \\
&= \vect{P}^- - \vect{K}\vect{C}\vect{P}^- - (\vect{K}\vect{C}\vect{P}^-)^\T + \vect{K}\vect{S}\vect{K}^\T
\end{align}

\section{Numerical Safeguards and Stability}

\subsection{Positive Semi-Definite Projection}

For any covariance matrix $\vect{S}$:
\begin{align}
\vect{S} &\leftarrow \frac{1}{2}(\vect{S} + \vect{S}^\T) \quad \text{(symmetrize)} \\
\vect{S} &= \vect{V} \vect{\Lambda} \vect{V}^\T \quad \text{(eigen decomposition)} \\
\lambda_i^+ &= \max(\lambda_i, \epsilon) \quad \text{for } i=1,\dots,n \\
\vect{S} &\leftarrow \vect{V} \vect{\Lambda}^+ \vect{V}^\T \\
\vect{S} &\leftarrow \frac{1}{2}(\vect{S} + \vect{S}^\T) \quad \text{(re-symmetrize)}
\end{align}
with $\epsilon = 10^{-12}$ for 4×4 matrices, $\epsilon = 10^{-16}$ for 12×12 matrices.

\subsection{Stable Matrix Inversion}

For innovation covariance $\vect{S}$:
\begin{align}
\delta &= \max(\epsilon, 10^{-6}(\|\vect{S}\| + 1)) \\
\vect{S} &\leftarrow \vect{S} + \delta \vect{I} \quad \text{(diagonal boost if LDLT fails)} \\
\vect{S}^{-1} &\approx \text{LDLT\_solve}(\vect{S})
\end{align}

\subsection{Measurement Gating}

Accelerometer measurement gate:
\begin{equation}
\text{Accept measurement if } |\|\vect{a}_{\text{meas}}\| - g| < 2g
\end{equation}

Magnetometer measurement gate:
\begin{equation}
\text{Accept measurement if } \|\vect{m}_{\text{meas}}\| > 10^{-6} \text{ and } \|\vect{m}_{\text{pred}}\| > 10^{-6}
\end{equation}

\section{Initialization Procedures}

\subsection{From Accelerometer and Magnetometer}

\begin{align}
\vect{z}_w &= -\frac{\vect{a}_b}{\|\vect{a}_b\|} \quad \text{(world down from accelerometer)} \\
\vect{m}_h &= \vect{m}_b - (\vect{m}_b \cdot \vect{z}_w)\vect{z}_w \quad \text{(horizontal magnetic component)} \\
\vect{x}_w &= \frac{\vect{m}_h}{\|\vect{m}_h\|} \quad \text{(world north from magnetometer)} \\
\vect{y}_w &= \vect{z}_w \times \vect{x}_w \quad \text{(world east)}
\end{align}

World-to-body rotation matrix:
\begin{equation}
\vect{R}_{wb} = \begin{bmatrix} \vect{x}_w & \vect{y}_w & \vect{z}_w \end{bmatrix}
\end{equation}

Quaternion initialization:
\begin{equation}
\quat{q}_{\text{ref}} = \text{Quaternion}(\vect{R}_{wb})
\end{equation}

Magnetic reference vector:
\begin{equation}
\vect{B}_{\text{ref}} = \vect{R}_{wb}^\T \vect{m}_b
\end{equation}

\subsection{From Accelerometer Only}

\begin{align}
\vect{a}_n &= \frac{\vect{a}}{\|\vect{a}\|} \\
\cos\theta &= \vect{e}_z \cdot (-\vect{a}_n), \quad \vect{e}_z = [0, 0, 1]^\T \\
\vect{\text{axis}} &= 
\begin{cases}
\vect{e}_x = [1, 0, 0]^\T & \text{if } |\cos\theta + 1| < 10^{-8} \text{ (anti-parallel)} \\
\frac{\vect{e}_z \times (-\vect{a}_n)}{\|\vect{e}_z \times (-\vect{a}_n)\|} & \text{otherwise}
\end{cases} \\
\quat{q} &= 
\begin{bmatrix}
\cos(\theta/2) \\
\sin(\theta/2) \vect{\text{axis}}
\end{bmatrix}
\end{align}

\subsection{Magnetic Reference from Declination and Inclination}

\begin{equation}
\vect{B}_{\text{ref}} = B \begin{bmatrix}
\cos I \cos D \\
\cos I \sin D \\
\sin I
\end{bmatrix}
\end{equation}
where $D$ is declination (East positive), $I$ is inclination (Down positive), $B$ is field strength.

\section{Parameter Initialization and Default Values}

\subsection{Initial Covariance}

\begin{align}
\vect{P}_{\theta\theta} &= \vect{I} \cdot 10^{-6} \quad \text{(attitude error)} \\
\vect{P}_{b_g b_g} &= \vect{I} \cdot 10^{-1} \quad \text{(gyro bias)} \\
\vect{P}_{vv} &= \vect{I} \cdot 1^2 \quad \text{(velocity)} \\
\vect{P}_{pp} &= \vect{I} \cdot 20^2 \quad \text{(position)} \\
\vect{P}_{SS} &= \vect{I} \cdot 50^2 \quad \text{(integral)} \\
\vect{P}_{a_w a_w} &= \vect{\Sigma}_{\text{aw\_stat}} \quad \text{(world acceleration)} \\
\vect{P}_{b_a b_a} &= \vect{I} \cdot 0.1^2 \quad \text{(accel bias)}
\end{align}

\subsection{Process Noise Defaults}

\begin{align}
\vect{Q}_{bg} &= \vect{I} \cdot 10^{-12} \quad \text{(gyro bias random walk)} \\
\vect{Q}_{ba} &= \vect{I} \cdot 10^{-8} \quad \text{(accel bias random walk)} \\
\tau_{aw} &= 2.3 \text{ seconds} \quad \text{(OU time constant)} \\
\vect{\Sigma}_{\text{aw\_stat}} &= \vect{I} \cdot (2.4)^2 \quad \text{(world acceleration variance)} \\
\vect{k}_a &= [0.003, 0.003, 0.003]^\T \quad \text{(temp coeff, m/s²/°C)}
\end{align}

\subsection{Measurement Noise Defaults}

\begin{align}
\vect{R}_{\text{acc}} &= \text{diag}(\sigma_a^2) \\
\vect{R}_{\text{mag}} &= \text{diag}(\sigma_m^2) \\
\vect{R}_S &= \vect{I} \cdot 1.5^2 \quad \text{(integral state noise)}
\end{align}

\section{Implementation Constants}

\begin{align*}
\text{PSEUDO\_UPDATE\_PERIOD} &= 3 \quad \text{(integral correction frequency)} \\
\text{tempC\_ref} &= 35.0 \quad \text{(reference temperature in °C)} \\
\delta_{\text{bias}} &= 10^{-8} \quad \text{(minimum time constant)} \\
\epsilon_{\text{psd4}} &= 10^{-12} \quad \text{(4×4 PSD projection tolerance)} \\
\epsilon_{\text{psd12}} &= 10^{-16} \quad \text{(12×12 PSD projection tolerance)}
\end{align*}

\end{document}
