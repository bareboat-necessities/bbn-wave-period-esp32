\documentclass{article}
\usepackage{amsmath, amsfonts, amssymb, graphicx}
\usepackage{tikz}
\usetikzlibrary{arrows.meta, positioning}

\begin{document}
\begin{center}
\begin{tikzpicture}[
    node distance=2cm,
    block/.style = {rectangle, draw, align=center, minimum width=3cm, minimum height=1cm},
    line/.style = {draw, -Latex, thick}
]

    % Top layer
    \node[block] (imu) {IMU};
    \node[block, below=of imu] (ahrs) {AHRS (Mahony, KalmanQMEKF)};

    % Middle layer
    \node[block, below=3cm of ahrs, minimum width=4cm] (freq) {Frequency Tracker:\\ Aranovskiy \\ Kalm\_ANF \\ Zero Crossing};
    \node[block, below=3cm of freq, minimum width=3cm] (wave_direction) {Kalman Wave Direction};
    \node[block, left=5cm of wave_direction, minimum width=2.5cm] (roll_pitch) {roll \\ pitch \\ yaw \\ rate of turn};
    \node[block, right=5cm of wave_direction, minimum width=3.2cm] (sea_state) {Sea State Detection};
    \node[block, below=1.5cm of sea_state, minimum width=3.8cm] (process_noise) {Process Noise Adaptation};
    \node[block, below=3cm of wave_direction, minimum width=8cm] (heave_reconstruction) {Kalman Heave Reconstruction \\ Kalman Integration with Drift Correction \\ Kalman Integration with Drift and Motor Noise Filtering};

    % Bottom layer
    \node[block, below=of heave_reconstruction, xshift=-3.5cm, minimum width=2.5cm] (minmax) {MinMaxLemire};
    \node[block, below=of heave_reconstruction, xshift=3.5cm, minimum width=3cm] (wave_profile) {Wave Profile Predictor};
    \node[block, left=5cm of heave_reconstruction, minimum width=2.5cm] (angle_dir) {angle, dir};    
    \node[block, below=3cm of heave_reconstruction, minimum width=7.5cm] (nmea) {NMEA Data Stream (XDR Sentences)};
    \node[block, right=of process_noise, minimum width=2.5cm] (despike) {De-Spike};

    %------------------ Connections ------------------

    % IMU → AHRS (orthogonal fan-in)
    \draw[line] (imu.south west) |- (ahrs.north west) node[pos=0.25, above] {gyro};
    \draw[line] (imu.south) -- (ahrs.north) node[midway, right] {magn};
    \draw[line] (imu.south east) |- (ahrs.north east) node[pos=0.25, above] {accel};

    % AHRS outputs
    \draw[line] (ahrs.south) |- (freq.north) node[pos=0.75, right] {$a_z$};
    \draw[line] (ahrs.west) -| (roll_pitch.north) node[pos=0.75, above] {$a_x, a_y$};
    \draw[line] (ahrs.east) -| (despike.north) node[pos=0.75, above] {$a_z$};

    % Freq → Wave direction + Sea state
    \draw[line] (freq.south) -- (wave_direction.north) node[midway, left] {$f_{est}$};
    \draw[line] (freq.east) -| (sea_state.north) node[pos=0.75, above] {$f_{est}$};

    % Sea state → Process noise → Heave
    \draw[line] (sea_state.south) -- (process_noise.north) node[midway, left] {$R_{reg}, H_{est}$};
    \draw[line] (process_noise.south) -| (heave_reconstruction.east) node[pos=0.75, left] {$Q$};

    % Despike → Heave
    \draw[line] (despike.south) |- (heave_reconstruction.east) node[pos=0.75, right] {$a_z$};

    % Wave direction / Roll / Angle → NMEA
    \draw[line] (wave_direction.south) -- (nmea.north);
    \draw[line] (roll_pitch.south) |- (nmea.west);
    \draw[line] (angle_dir.east) -- (nmea.west);

    % Heave outputs
    \draw[line] (heave_reconstruction.south) -- (nmea.north) node[midway, left] {heave \\ period \\ length \\ speed};
    \draw[line] (heave_reconstruction.south west) -- (minmax.north) node[midway, right] {heave};
    \draw[line] (heave_reconstruction.south east) -- (wave_profile.north) node[midway, left] {heave};

    % MinMax → NMEA
    \draw[line] (minmax.south) |- (nmea.west) node[pos=0.75, right] {wave height};

\end{tikzpicture}
\end{center}
\end{document}
