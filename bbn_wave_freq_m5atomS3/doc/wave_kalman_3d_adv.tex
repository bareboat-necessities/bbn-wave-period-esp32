\documentclass[11pt]{article}
\usepackage{amsmath, amssymb, amsfonts, bm}
\usepackage{geometry}
\usepackage{hyperref}
\geometry{margin=1in}

\title{A Multiplicative EKF with Latent OU Acceleration for Drift-Robust Wave Kinematics: \\
Theory, Discretization (Rodrigues, Van Loan, Pad\'e(6)), and Temperature-Dependent Bias Compensation}
\author{Mikhail Grushinskiy}
\date{2025}

\begin{document}
\maketitle

\begin{abstract}
We present a detailed mathematical development of a quaternion multiplicative EKF (MEKF) fused with an extended 
linear kinematic chain for ocean-wave motion estimation. 
The method augments attitude (with optional gyroscope bias) by the linear states velocity $\bm v$, displacement $\bm p$, 
and the integral of displacement $\bm S$, driven by a \emph{latent} world-frame acceleration $\bm a_w$ modeled as an Ornstein--Uhlenbeck (OU) process. 
The OU prior confers bounded variance and realistic temporal correlation, preventing the drift explosion typical of double integration of noisy accelerometer data. 
Biases are explicitly modeled: gyroscope bias as a random walk, accelerometer bias both as random walk and as systematic temperature-dependent drift. 
A pseudo-measurement is introduced on $\bm S$ to control triple integral divergence. 
We derive continuous- and discrete-time process models, show Rodrigues and Van Loan discretizations, 
explain Pad\'e(6) approximation with scaling and squaring, and derive explicit Jacobians for accelerometer and magnetometer updates. 
Finally, we discuss tuning strategies and the prospect of adaptive parameter estimation.
\end{abstract}

\section{Introduction}
Estimating wave-induced motion from an IMU is fundamentally challenging. The IMU provides angular velocity and specific force, 
but extracting displacement requires triple integration if treated naively. Biases and noise cause unbounded drift. 
Moreover, wave accelerations are not white but correlated in time, reflecting the physics of sea surface gravity waves. 
Thus, a specialized state-space formulation is required. 

The \texttt{Kalman3D\_Wave} filter is designed with these challenges in mind. 
It is a multiplicative EKF in which the quaternion is the central orientation representation, 
augmented by translational kinematics driven by a latent Ornstein--Uhlenbeck acceleration process. 
This design provides bounded variance, stability, and physical realism.

The contributions of this paper are:
\begin{itemize}
\item A rigorous derivation of the state-space model with biases and OU latent acceleration.
\item Exact and approximate discretization methods: Rodrigues, Van Loan, Pad\'e(6).
\item Explicit Jacobians for accelerometer and magnetometer updates.
\item Introduction of a pseudo-measurement on the triple integral to suppress drift.
\item Discussion of tuning and future adaptive strategies.
\end{itemize}

\section{State Definition}

We define the full augmented error-state vector as
\begin{equation}
\bm{x} =
\begin{bmatrix}
\delta\bm\theta & \bm b_g & \bm v & \bm p & \bm S & \bm a_w & \bm b_{a0}
\end{bmatrix}^\top \in \mathbb{R}^n,
\label{eq:state_vector}
\end{equation}
with the following components:
\begin{itemize}
\item $\delta\bm\theta \in \mathbb{R}^3$: the \emph{attitude error}, parameterized as a small rotation vector in the multiplicative EKF framework.
\item $\bm b_g \in \mathbb{R}^3$: the gyroscope bias, modeled as a random walk driven by white noise.
\item $\bm v \in \mathbb{R}^3$: the velocity of the sensor in the world (NED) frame.
\item $\bm p \in \mathbb{R}^3$: the displacement (position) in the world frame.
\item $\bm S \in \mathbb{R}^3$: the \emph{integral of displacement}, i.e.
  \[
  \bm S(t) = \int_0^t \bm p(\tau)\, d\tau,
  \]
  which, although not physically measured, serves as a control variable for drift suppression.
\item $\bm a_w \in \mathbb{R}^3$: the latent world-frame acceleration, modeled as an Ornstein--Uhlenbeck (OU) process to enforce bounded variance and temporal correlation.
\item $\bm b_{a0} \in \mathbb{R}^3$: the baseline accelerometer bias at a fixed reference temperature $T_\text{ref}$.
\end{itemize}

The \emph{temperature-dependent accelerometer bias model} is given by
\begin{equation}
\bm b_a(T) = \bm b_{a0} + \bm k_a \,\big(T - T_\text{ref}\big),
\label{eq:accel_bias_temp}
\end{equation}
where $\bm k_a \in \mathbb{R}^3$ is a vector of per-axis temperature coefficients. 
This accounts for the systematic drift of MEMS accelerometers with changing temperature, 
typically on the order of $0.002$--$0.005 \,\text{m/s}^2$ per ${}^\circ$C in modern sensors.

\subsection{Quaternion Representation}
The orientation of the body frame with respect to the world (NED) frame is represented by a quaternion $q \in \mathbb{H}$. 
We adopt a right-multiplicative error convention:
\begin{equation}
q^+ = q \otimes \delta q(\delta\bm\theta),
\end{equation}
where $\otimes$ denotes quaternion multiplication and
\begin{equation}
\delta q(\delta\bm\theta) \approx
\begin{bmatrix}
1 \\ \tfrac{1}{2}\delta\bm\theta
\end{bmatrix}.
\label{eq:small_angle_quaternion}
\end{equation}

\subsection{State Dimension}
The total state dimension is
\[
n =
\begin{cases}
18 & \text{if gyro and accel biases are included}, \\
15 & \text{if only gyro bias is included}, \\
12 & \text{if no biases are included}.
\end{cases}
\]
This flexible design allows the filter to adapt to the sensor suite available and to application requirements.

\section{Attitude Dynamics}

The orientation of the sensor platform is represented by a quaternion $q(t)$ mapping from the world 
(North--East--Down, NED) frame to the body frame. 
We employ the \emph{multiplicative extended Kalman filter} (MEKF) convention: 
the mean orientation is stored as a quaternion $q$, while the small attitude error 
is represented as a 3-vector $\delta\bm\theta$ living in the tangent space $\mathfrak{so}(3)$.

\subsection{Quaternion Kinematics}
The quaternion time evolution is governed by the angular velocity measured by the gyroscope:
\begin{equation}
\dot q(t) = \tfrac{1}{2} \, \Omega(\bm\omega_b(t)) \, q(t),
\label{eq:quat_kinematics}
\end{equation}
where $\bm\omega_b$ is the angular velocity in the body frame, 
and $\Omega(\bm\omega)$ is the quaternion multiplication matrix:
\begin{equation}
\Omega(\bm\omega) =
\begin{bmatrix}
0 & -\bm\omega^\top \\
\bm\omega & -[\bm\omega]_\times
\end{bmatrix}.
\end{equation}

Here $[\bm\omega]_\times$ denotes the skew-symmetric matrix such that $[\bm\omega]_\times \bm v = \bm\omega \times \bm v$.

\subsection{Error Representation}
Instead of estimating $q$ directly, the MEKF keeps track of the \emph{error quaternion}:
\begin{equation}
q = \hat q \otimes \delta q(\delta\bm\theta),
\end{equation}
where $\hat q$ is the nominal quaternion and $\delta q$ is a small correction. 
This choice ensures that the state covariance remains minimal in dimension (3 instead of 4), 
while preserving the unit norm of $q$.

\subsection{Rodrigues' Formula for Discrete Propagation}
To propagate the quaternion over a sampling interval $\Delta t$, 
we use the matrix exponential of the skew operator:
\begin{equation}
R(t+\Delta t) = R(t) \exp\!\left([\bm\omega]_\times \Delta t\right).
\label{eq:rot_exp}
\end{equation}

Rodrigues' rotation formula provides a closed form for this exponential:
\begin{equation}
\exp([\bm\omega]_\times \Delta t) = I 
+ \frac{\sin \theta}{\theta} [\bm u]_\times
+ \frac{1 - \cos \theta}{\theta^2} [\bm u]_\times^2,
\label{eq:rodrigues}
\end{equation}
where $\theta = \|\bm\omega\| \Delta t$ is the rotation angle, 
and $\bm u = \bm\omega / \|\bm\omega\|$ is the unit rotation axis.

\paragraph{Interpretation.}
Equation \eqref{eq:rodrigues} shows how the rotation matrix can be expressed 
directly in terms of the angular increment. 
For small angles, a Taylor expansion recovers the familiar linearized form:
\[
\exp([\bm\omega]_\times \Delta t) \approx I + [\bm\omega]_\times \Delta t + \tfrac{1}{2} [\bm\omega]_\times^2 \Delta t^2.
\]
This makes Rodrigues' formula both numerically stable and exact for finite rotations.

\subsection{Error-State Dynamics}
The small attitude error $\delta\bm\theta$ evolves according to
\begin{equation}
\dot{\delta\bm\theta} = -[\bm\omega_b - \bm b_g]_\times \, \delta\bm\theta - \delta\bm b_g + \bm n_\theta,
\label{eq:att_err_dyn}
\end{equation}
where $\bm b_g$ is the gyro bias and $\bm n_\theta$ is gyro measurement noise mapped into the attitude error dynamics.

Equation \eqref{eq:att_err_dyn} highlights two important points:
\begin{enumerate}
\item The gyro bias directly drives the attitude error, which motivates its inclusion in the state vector.
\item The dynamics are linear in the small error, allowing standard EKF propagation.
\end{enumerate}

\section{Ornstein--Uhlenbeck (OU) Process: Mean/Variance, Autocorrelation, Discrete-Time, and Coefficient Integrals}
\label{sec:ou-detailed}

This section develops the OU dynamics used for the latent world-frame acceleration $a(t)$
(per axis; the 3D case is component-wise identical). We give the continuous-time SDE,
solve it in closed form, derive the exact discrete-time equivalent, compute the
autocorrelation and spectrum, and then derive the integral coefficients that appear
in the discrete propagation of $(v,p,S)$.

\subsection{Two Equivalent Formulations of OU}
There are two standard ways to write the OU process.

\paragraph{(i) It\^o SDE form.}
\begin{equation}
da(t) \;=\; -\frac{1}{\tau}\,a(t)\,dt \;+\; \sqrt{\frac{2\sigma^2}{\tau}}\; dW_t,
\label{eq:ou-ito}
\end{equation}
where $\tau>0$ is the correlation time, $\sigma^2$ is the stationary variance, and $W_t$
is a standard Wiener process.

\paragraph{(ii) LTI with white process input.}
\begin{equation}
\dot a(t) \;=\; -\frac{1}{\tau}\,a(t) \;+\; w(t),\qquad
\mathbb{E}\big[w(t)w(s)\big] \;=\; \Sigma_c\,\delta(t-s),
\label{eq:ou-lti}
\end{equation}
with the white-noise \emph{power} chosen as
\begin{equation}
\Sigma_c \;=\; \frac{2}{\tau}\,\sigma^2,
\label{eq:ou-sigmapower}
\end{equation}
which makes the stationary variance of $a(t)$ equal to $\sigma^2$ (same as in \eqref{eq:ou-ito}).

Both forms are equivalent; the It\^o diffusion coefficient $\sqrt{2\sigma^2/\tau}$ corresponds to
the white-noise power $\Sigma_c = 2\sigma^2/\tau$ in the LTI description.

\subsection{Closed-Form Solution and Moments}
Solving \eqref{eq:ou-lti} with constant $\tau$ over $[t,t+\Delta]$:
\begin{equation}
a(t+\Delta) \;=\; \rho\,a(t) \;+\; \int_0^\Delta e^{-(\Delta-s)/\tau}\,w(t+s)\,ds,
\qquad
\rho \;\triangleq\; e^{-\Delta/\tau}.
\label{eq:ou-sol}
\end{equation}
Therefore,
\begin{align}
\mathbb{E}[\,a(t+\Delta)\,|\,a(t)=a_k] &= \rho\,a_k, \label{eq:ou-mean}\\
\mathrm{Var}[\,a(t+\Delta)\,|\,a(t)=a_k] 
&= \int_0^\Delta\!\!\int_0^\Delta e^{-(\Delta-s)/\tau}e^{-(\Delta-u)/\tau}\,\Sigma_c\,\delta(s-u)\,ds\,du
\nonumber\\
&= \Sigma_c \int_0^\Delta e^{-2(\Delta-s)/\tau}\,ds
= \frac{\Sigma_c\tau}{2}\,\big(1-\rho^2\big).
\end{align}
Using \eqref{eq:ou-sigmapower} gives the standard result
\begin{equation}
\mathrm{Var}[\,a(t+\Delta)\,|\,a(t)=a_k] \;=\; \sigma^2\big(1-\rho^2\big).
\label{eq:ou-var-step}
\end{equation}

\subsection{Autocorrelation and Spectrum}
At stationarity,
\begin{equation}
R_a(\Delta) \;\triangleq\; \mathbb{E}\big[a(t)\,a(t+\Delta)\big] \;=\; \sigma^2\,e^{-|\Delta|/\tau}.
\label{eq:ou-autocorr}
\end{equation}
The one-sided power spectral density (PSD) is the Lorentzian
\begin{equation}
S_a(\omega) \;=\; \int_{-\infty}^{\infty} R_a(\Delta)\,e^{-j\omega \Delta}\,d\Delta
\;=\; \frac{2\sigma^2\tau}{1+(\omega\tau)^2}.
\label{eq:ou-psd}
\end{equation}
Hence $\tau$ sets the correlation (and an approximate cutoff $f_c \approx (2\pi\tau)^{-1}$),
and $\sigma$ sets the RMS magnitude of $a$.

\subsection{Exact Discrete-Time Equivalent (AR(1))}
Discretizing at step $\Delta$,
\begin{equation}
a_{k+1} \;=\; \rho\,a_k \;+\; \eta_k,
\qquad
\rho \;=\; e^{-\Delta/\tau}, 
\qquad
\eta_k \sim \mathcal{N}\!\big(0,\ \sigma^2(1-\rho^2)\big),
\label{eq:ou-ar1}
\end{equation}
with $\eta_k$ independent of $a_k$. This AR(1) exactly preserves the OU mean, variance,
and autocorrelation at sampling instants.

\subsection{Integral Functionals of OU: Deterministic Coefficient Derivations}
Let $a(t)$ follow OU as above. Over one step $[t,t+\Delta]$, define the weighted
integrals needed by the kinematic chain:
\begin{equation}
I_0 \;\triangleq\; \int_0^\Delta a(t+s)\,ds,\qquad
I_1 \;\triangleq\; \int_0^\Delta (\Delta-s)\,a(t+s)\,ds,\qquad
I_2 \;\triangleq\; \int_0^\Delta \frac{(\Delta-s)^2}{2}\,a(t+s)\,ds.
\label{eq:ou-I012}
\end{equation}
Using the conditional mean $\mathbb{E}[a(t+s)\mid a(t){=}a_k]=e^{-s/\tau} a_k$,
the \emph{deterministic coefficients} multiplying $a_k$ in the discrete updates are:
\begin{align}
c_v(\Delta,\tau)
&= \int_0^\Delta e^{-s/\tau}\,ds
= \tau\big(1-e^{-\Delta/\tau}\big)
\;=\; \tau E_0, 
\label{eq:cv-ou}
\\
c_p(\Delta,\tau)
&= \int_0^\Delta (\Delta-s)\,e^{-s/\tau}\,ds
= \tau\Big(\Delta - \tau\big(1-e^{-\Delta/\tau}\big)\Big)
\;=\; \tau E_1, 
\label{eq:cp-ou}
\\
c_S(\Delta,\tau)
&= \int_0^\Delta \frac{(\Delta-s)^2}{2}\,e^{-s/\tau}\,ds
= \tau\left(\frac{\Delta^2}{2} - \tau\Delta + \tau^2\big(1-e^{-\Delta/\tau}\big)\right)
\;=\; \tau E_2.
\label{eq:cS-ou}
\end{align}
We have introduced the convenient polynomials
\begin{equation}
E_0(\Delta,\tau)=1-\rho,\qquad
E_1(\Delta,\tau)=\Delta - \tau(1-\rho),\qquad
E_2(\Delta,\tau)=\frac{\Delta^2}{2} - \tau\Delta + \tau^2(1-\rho),
\label{eq:E012}
\end{equation}
with $\rho=e^{-\Delta/\tau}$. For later use (e.g., in higher-order kernels), also define
\begin{equation}
E_3(\Delta,\tau)
\;\triangleq\;
\frac{\Delta^3}{6} - \frac{\tau\Delta^2}{2} + \tau^2\Delta - \tau^3(1-\rho).
\label{eq:E3}
\end{equation}

\paragraph{Resulting exact conditional means.}
The discrete kinematic updates with OU-driven acceleration are
\begin{align}
v_{k+1} &= v_k + c_v(\Delta,\tau)\,a_k + \varepsilon_v, \label{eq:v-disc-mean}\\
p_{k+1} &= p_k + \Delta v_k + c_p(\Delta,\tau)\,a_k + \varepsilon_p, \label{eq:p-disc-mean}\\
S_{k+1} &= S_k + \Delta p_k + \frac{\Delta^2}{2} v_k + c_S(\Delta,\tau)\,a_k + \varepsilon_S, \label{eq:S-disc-mean}
\end{align}
where the zero-mean random terms $(\varepsilon_v,\varepsilon_p,\varepsilon_S)$ are jointly Gaussian and arise from the
stochastic part of $a(t+s)$ (i.e., the integral of the noise term in \eqref{eq:ou-sol} through the integrator kernels).

\subsection{Variances and Covariances of the Integrated OU Terms}
Let $R_a(\delta)=\sigma^2 e^{-|\delta|/\tau}$ be the stationary autocorrelation \eqref{eq:ou-autocorr}.
For any weights $w(s)$, $u(s)$ supported on $[0,\Delta]$,
\begin{equation}
\mathrm{Cov}\!\left[\int_0^\Delta w(s) a(t+s)\,ds,\ \int_0^\Delta u(s) a(t+s)\,ds\right]
= \int_0^\Delta\!\!\int_0^\Delta w(s)\,u(u)\,R_a(s-u)\,ds\,du.
\label{eq:kernel-cov}
\end{equation}
Using symmetry $R_a(|s-u|)=\sigma^2 e^{-|s-u|/\tau}$ and splitting the domain $0\le u\le s\le \Delta$,
\begin{align}
\mathrm{Cov}
&= 2\sigma^2 \int_0^\Delta \left(\int_0^s w(s)\,u(u)\,e^{-(s-u)/\tau}\,du\right) ds.
\label{eq:kernel-cov-2}
\end{align}
We now list the key entries needed to build the exact discrete process covariance $Q_d$
for $(v,p,S,a)$ in one step. Denote $\rho=e^{-\Delta/\tau}$, and recall \eqref{eq:E012}.

\paragraph{Single-integral variance and cross-covariance.}
With $w_0(s)=1$ and $w_1(s)=\Delta-s$,
\begin{align}
\mathrm{Var}\!\left[\int_0^\Delta a\right]
&= 2\sigma^2 \tau\,E_1,
\label{eq:var-I0}
\\
\mathrm{Cov}\!\left[\int_0^\Delta a,\ \int_0^\Delta (\Delta-s)a\right]
&= 2\sigma^2 \tau\,E_2,
\label{eq:cov-I0-I1}
\\
\mathrm{Var}\!\left[\int_0^\Delta (\Delta-s)a\right]
&= 2\sigma^2 \tau\left(\frac{\Delta^3}{3} - \tau\Delta^2 + 2\tau^2\Delta - 2\tau^3(1-\rho)\right).
\label{eq:var-I1}
\end{align}

\paragraph{Cross-covariances with $a_{k+1}$.}
From $\mathrm{cov}\{a(t+s),a(t+\Delta)\}=\sigma^2 e^{-(\Delta-s)/\tau}$:
\begin{align}
\mathrm{Cov}\!\left[\int_0^\Delta a(t+s)\,ds,\ a_{k+1}\right]
&= \sigma^2 \tau (1-\rho)
= \sigma^2 \tau E_0,
\label{eq:cov-I0-ak1}
\\
\mathrm{Cov}\!\left[\int_0^\Delta (\Delta-s)a(t+s)\,ds,\ a_{k+1}\right]
&= \sigma^2\left(\tau^2(1-\rho) - \tau\Delta\,\rho\right).
\label{eq:cov-I1-ak1}
\end{align}
(Analogous expressions for the $S$-weighted integral follow the same recipe but are longer; see the coefficient identity below.)

\paragraph{General exponential--polynomial identity.}
All required integrals reduce to the elementary identity
\begin{equation}
\int_0^\Delta s^n e^{-s/\tau} ds
= \tau^{n+1}\,n!\left(1 - e^{-\Delta/\tau}\sum_{j=0}^{n}\frac{(\Delta/\tau)^j}{j!}\right),
\qquad n=0,1,2,\dots,
\label{eq:exp-poly}
\end{equation}
together with the binomial expansion $(\Delta-s)^m=\sum_{i=0}^m \binom{m}{i}\Delta^{m-i}(-s)^i$.
Using \eqref{eq:exp-poly} yields closed forms for \emph{all} entries of $Q_d$ (including the $S$-block).

\subsection{Exact Axis Transition for $(v,p,S,a)$}
Collecting the deterministic coefficients \eqref{eq:cv-ou}--\eqref{eq:cS-ou} and the OU state update \eqref{eq:ou-ar1},
the \emph{exact} one-axis transition matrix is
\begin{equation}
\Phi_{\text{axis}}(\Delta,\tau) \;=\;
\begin{bmatrix}
1 & 0 & 0 & \tau(1-\rho)\\
0 & 1 & 0 & \tau\big(\Delta - \tau(1-\rho)\big)\\
0 & 0 & 1 & \tau\left(\tfrac{\Delta^2}{2} - \tau\Delta + \tau^2(1-\rho)\right)\\
0 & 0 & 0 & \rho
\end{bmatrix}.
\label{eq:Phi-axis-ou}
\end{equation}
In 3D, $\Phi_{vpsa}=\Phi_{\text{axis}}\otimes I_3$.

\paragraph{Discrete process covariance $Q_d$.}
The random vector $(\varepsilon_v,\varepsilon_p,\varepsilon_S,\eta_a)$ has covariance determined by
\eqref{eq:var-I0}--\eqref{eq:var-I1}, \eqref{eq:cov-I0-ak1}--\eqref{eq:cov-I1-ak1}, and their $S$-weighted analogs
(constructed via \eqref{eq:exp-poly}). For compactness and guaranteed SPD, we also obtain $Q_d$
by the Van Loan method applied to the continuous pair $(A,G,\Sigma_c)$ (see the discretization section):
\[
Q_d \;=\; \int_0^\Delta e^{A s} G \Sigma_c G^\top e^{A^\top s} ds.
\]
Both routes are analytically equivalent; Van Loan is the numerically convenient implementation.

\subsection{Small-Step Expansions and Limiting Cases}
For $\Delta\ll\tau$ ($\rho \approx 1-\Delta/\tau$):
\begin{align}
c_v &= \tau(1-\rho) \approx \Delta - \tfrac{\Delta^2}{2\tau} + \mathcal{O}(\Delta^3),\\
c_p &= \tau\big(\Delta - \tau(1-\rho)\big) \approx \tfrac{\Delta^2}{2} - \tfrac{\Delta^3}{6\tau} + \mathcal{O}(\Delta^4),\\
c_S &= \tau\!\left(\tfrac{\Delta^2}{2} - \tau\Delta + \tau^2(1-\rho)\right) \approx \tfrac{\Delta^3}{6} - \tfrac{\Delta^4}{24\tau} + \mathcal{O}(\Delta^5).
\end{align}
These match the deterministic integrals of a constant acceleration over small intervals.

As $\tau\to\infty$ with $\sigma^2$ fixed, $\rho\to 1$, the innovation variance $\sigma^2(1-\rho^2)\to 0$,
and $a$ becomes quasi-constant (very slow mean reversion). As $\tau\to 0$, $\rho\to 0$ and
the process approaches temporally white acceleration (with variance $\sigma^2$ at the sampling instants),
recovering the uncorrelated case.




